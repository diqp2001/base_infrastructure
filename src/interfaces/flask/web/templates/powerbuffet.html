<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerBuffet - Data Visualization & Database Explorer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .powerbuffet-container {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .control-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .visualization-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 600px;
        }
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 50px;
        }
        .table-info {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .success-message {
            background: #d1edff;
            color: #0c5460;
            border: 1px solid #b8daff;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        
        /* Drag and Drop Styles */
        .drag-drop-area {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
            min-height: 150px;
            transition: all 0.3s ease;
        }
        
        .drag-drop-area.drag-over {
            border-color: #0d6efd;
            background-color: #e7f3ff;
        }
        
        .column-item {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 4px;
            cursor: grab;
            display: inline-block;
            font-size: 12px;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .column-item:hover {
            background: #e9ecef;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        
        .column-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }
        
        .column-item.in-use {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        
        .selected-columns {
            background: white;
            border-radius: 6px;
            padding: 10px;
            min-height: 40px;
            border: 1px solid #dee2e6;
        }
        
        .axis-section {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .database-columns {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px;
            background: #fafafa;
        }
        
        .stats-section {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .remove-column {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            line-height: 1;
            cursor: pointer;
            margin-left: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .database-header {
            font-weight: bold;
            color: #495057;
            background: #e9ecef;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 8px 0 4px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="powerbuffet-container">
        <div class="container-fluid py-4">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h2 mb-0">üìä PowerBuffet</h1>
                            <p class="text-muted mb-0">Data Visualization & Database Explorer</p>
                        </div>
                        <a href="{{ url_for('web.dashboard_hub') }}" class="btn btn-outline-primary">
                            ‚Üê Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>

            <!-- Enhanced Control Panel with Drag & Drop -->
            <div class="row">
                <div class="col-12">
                    <div class="control-panel">
                        <h4 class="mb-3">Multi-Database Column Selection & Visualization</h4>
                        
                        <!-- Available Databases and Columns -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="mb-2">Available Data Sources & Columns</h6>
                                <div id="availableColumnsContainer" class="database-columns">
                                    <div class="text-muted p-3 text-center">
                                        <i>Loading data sources...</i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Drag and Drop Areas for Axes -->
                        <div class="row">
                            <!-- X-Axis Selection -->
                            <div class="col-md-6">
                                <div class="axis-section">
                                    <h6 class="mb-2">üìä X-Axis Columns</h6>
                                    <p class="text-muted small mb-2">Drag columns here for X-axis data</p>
                                    <div class="drag-drop-area" id="xAxisDropZone" ondrop="drop(event, 'x')" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                                        <div id="xAxisColumns" class="selected-columns">
                                            <span class="text-muted">Drop columns here for X-axis</span>
                                        </div>
                                    </div>
                                    <div id="xAxisStats" class="stats-section" style="display: none;">
                                        <h6>X-Axis Statistics</h6>
                                        <div id="xAxisStatsContent"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Y-Axis Selection -->
                            <div class="col-md-6">
                                <div class="axis-section">
                                    <h6 class="mb-2">üìà Y-Axis Columns</h6>
                                    <p class="text-muted small mb-2">Drag columns here for Y-axis data</p>
                                    <div class="drag-drop-area" id="yAxisDropZone" ondrop="drop(event, 'y')" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                                        <div id="yAxisColumns" class="selected-columns">
                                            <span class="text-muted">Drop columns here for Y-axis</span>
                                        </div>
                                    </div>
                                    <div id="yAxisStats" class="stats-section" style="display: none;">
                                        <h6>Y-Axis Statistics</h6>
                                        <div id="yAxisStatsContent"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Visualization Controls -->
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <label for="chartTypeSelect" class="form-label">Chart Type</label>
                                <select class="form-select" id="chartTypeSelect">
                                    <option value="scatter">Scatter Plot</option>
                                    <option value="line">Line Chart</option>
                                    <option value="bar">Bar Chart</option>
                                    <option value="histogram">Histogram</option>
                                    <option value="correlation">Correlation Heatmap</option>
                                </select>
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <button class="btn btn-primary w-100" id="generateCustomBtn" onclick="generateCustomVisualization()" disabled>
                                    üé® Generate Custom Visualization
                                </button>
                            </div>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <button class="btn btn-outline-secondary btn-sm me-2" onclick="clearAllSelections()">Clear All</button>
                                <button class="btn btn-outline-info btn-sm me-2" onclick="loadSampleConfiguration()">Load Sample Config</button>
                                <button class="btn btn-outline-success btn-sm" onclick="saveConfiguration()">Save Configuration</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Visualization Container -->
            <div class="row">
                <div class="col-12">
                    <div class="visualization-container">
                        <div id="welcomeMessage" class="text-center py-5">
                            <h3 class="text-muted mb-3">Welcome to PowerBuffet!</h3>
                            <p class="text-muted">Select a database, table, and visualization type to get started with your data exploration.</p>
                            <div class="mt-4">
                                <h5>Available Features:</h5>
                                <ul class="list-unstyled">
                                    <li>üìä Portfolio Performance Analysis</li>
                                    <li>üîó Asset Correlation Heatmaps</li>
                                    <li>ü•ß Sector Distribution Charts</li>
                                    <li>üí∞ Market Cap Analysis</li>
                                    <li>üìà Trading Volume Trends</li>
                                    <li>üìã Financial Ratios Comparison</li>
                                    <li>‚è±Ô∏è Time Series Analysis</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div id="loadingSpinner" class="loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3">Generating visualization...</p>
                        </div>
                        
                        <div id="errorMessage" class="error-message" style="display: none;"></div>
                        <div id="successMessage" class="success-message" style="display: none;"></div>
                        
                        <div id="plotContainer" style="width: 100%; height: 500px;"></div>
                        <div id="statsContainer" style="display: none;">
                            <h5 class="mt-4">Summary Statistics:</h5>
                            <div id="statsContent" class="row"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentTables = [];
        let allDatabases = [];
        let selectedColumns = {
            x: [],  // Array of {database, table, column, data, stats}
            y: []   // Array of {database, table, column, data, stats}
        };

        function loadTables() {
            const databaseSelect = document.getElementById('databaseSelect');
            const tableSelect = document.getElementById('tableSelect');
            const visualizationSelect = document.getElementById('visualizationSelect');
            const generateBtn = document.getElementById('generateBtn');
            const tableInfoPanel = document.getElementById('tableInfoPanel');
            
            // Reset dependent selectors
            tableSelect.innerHTML = '<option value="">Select a table...</option>';
            tableSelect.disabled = true;
            visualizationSelect.disabled = true;
            generateBtn.disabled = true;
            tableInfoPanel.style.display = 'none';
            
            if (!databaseSelect.value) return;
            
            // Show loading
            showMessage('Loading tables...', 'info');
            
            fetch(`/api/powerbuffet/tables/${encodeURIComponent(databaseSelect.value)}`)
                .then(response => response.json())
                .then(data => {
                    hideMessages();
                    if (data.success) {
                        currentTables = data.tables;
                        data.tables.forEach(table => {
                            const option = document.createElement('option');
                            option.value = table.name;
                            option.textContent = `${table.name} (${table.row_count} rows)`;
                            tableSelect.appendChild(option);
                        });
                        tableSelect.disabled = false;
                    } else {
                        showMessage(`Error loading tables: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    hideMessages();
                    showMessage(`Error loading tables: ${error.message}`, 'error');
                });
        }

        function showTableInfo() {
            const tableSelect = document.getElementById('tableSelect');
            const visualizationSelect = document.getElementById('visualizationSelect');
            const generateBtn = document.getElementById('generateBtn');
            const tableInfoPanel = document.getElementById('tableInfoPanel');
            const tableInfoContent = document.getElementById('tableInfoContent');
            
            if (!tableSelect.value) {
                tableInfoPanel.style.display = 'none';
                visualizationSelect.disabled = true;
                generateBtn.disabled = true;
                return;
            }
            
            const selectedTable = currentTables.find(table => table.name === tableSelect.value);
            if (selectedTable) {
                let columnsHtml = '<div class="row">';
                columnsHtml += `<div class="col-md-6"><strong>Rows:</strong> ${selectedTable.row_count}</div>`;
                columnsHtml += `<div class="col-md-6"><strong>Columns:</strong> ${selectedTable.columns.length}</div>`;
                columnsHtml += '</div><div class="mt-2"><strong>Column Details:</strong><ul class="mb-0">';
                
                selectedTable.columns.forEach(column => {
                    columnsHtml += `<li>${column.name} (${column.type})</li>`;
                });
                columnsHtml += '</ul></div>';
                
                tableInfoContent.innerHTML = columnsHtml;
                tableInfoPanel.style.display = 'block';
                visualizationSelect.disabled = false;
            }
            
            updateGenerateButton();
        }

        function updateGenerateButton() {
            const databaseSelect = document.getElementById('databaseSelect');
            const tableSelect = document.getElementById('tableSelect');
            const visualizationSelect = document.getElementById('visualizationSelect');
            const generateBtn = document.getElementById('generateBtn');
            
            generateBtn.disabled = !(databaseSelect.value && tableSelect.value && visualizationSelect.value);
        }

        function generateVisualization() {
            const databaseSelect = document.getElementById('databaseSelect');
            const tableSelect = document.getElementById('tableSelect');
            const visualizationSelect = document.getElementById('visualizationSelect');
            const welcomeMessage = document.getElementById('welcomeMessage');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const plotContainer = document.getElementById('plotContainer');
            const statsContainer = document.getElementById('statsContainer');
            
            // Show loading state
            welcomeMessage.style.display = 'none';
            loadingSpinner.style.display = 'block';
            plotContainer.innerHTML = '';
            statsContainer.style.display = 'none';
            hideMessages();
            
            const requestData = {
                database_path: databaseSelect.value,
                table_name: tableSelect.value,
                visualization_name: visualizationSelect.value,
                params: {}
            };
            
            fetch('/api/powerbuffet/run_visualization', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                loadingSpinner.style.display = 'none';
                
                if (data.success) {
                    if (data.visualization.error) {
                        showMessage(`Visualization Error: ${data.visualization.error}`, 'error');
                    } else {
                        showMessage('Visualization generated successfully!', 'success');
                        
                        // Display the plot
                        if (data.visualization.plot_image) {
                            document.getElementById('plotContainer').innerHTML = 
                                `<img src="data:image/png;base64,${data.visualization.plot_image}" 
                                 class="img-fluid" alt="Visualization" style="max-width: 100%; height: auto;">`;
                        }
                        
                        // Display summary statistics if available
                        if (data.visualization.summary_stats) {
                            displayStats(data.visualization.summary_stats);
                        }
                    }
                } else {
                    showMessage(`Error: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                loadingSpinner.style.display = 'none';
                showMessage(`Error generating visualization: ${error.message}`, 'error');
            });
        }

        function displayStats(stats) {
            const statsContainer = document.getElementById('statsContainer');
            const statsContent = document.getElementById('statsContent');
            
            let html = '';
            Object.entries(stats).forEach(([key, value]) => {
                html += `
                    <div class="col-md-3 mb-2">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <h6 class="card-title text-muted">${key.replace('_', ' ').toUpperCase()}</h6>
                                <h4 class="card-text">${typeof value === 'number' ? value.toFixed(2) : value}</h4>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            statsContent.innerHTML = html;
            statsContainer.style.display = 'block';
        }

        function showMessage(message, type) {
            hideMessages();
            const messageElement = type === 'error' ? 
                document.getElementById('errorMessage') : 
                document.getElementById('successMessage');
            
            messageElement.textContent = message;
            messageElement.style.display = 'block';
        }

        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        // Enhanced functionality for drag-and-drop interface
        
        function loadAllDatabasesAndColumns() {
            """Load all available databases and their columns for drag-drop interface"""
            fetch('/api/powerbuffet/databases')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        allDatabases = data.databases;
                        loadAllColumns();
                    } else {
                        showMessage(`Error loading databases: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    showMessage(`Error loading databases: ${error.message}`, 'error');
                });
        }
        
        function loadAllColumns() {
            """Load columns from all databases"""
            const container = document.getElementById('availableColumnsContainer');
            container.innerHTML = '<div class="text-muted p-3 text-center">Loading columns...</div>';
            
            Promise.all(allDatabases.map(db => 
                fetch(`/api/powerbuffet/tables/${encodeURIComponent(db.path)}`)
                    .then(response => response.json())
                    .then(data => ({ db, tables: data.success ? data.tables : [] }))
            ))
            .then(results => {
                displayAvailableColumns(results);
            })
            .catch(error => {
                container.innerHTML = `<div class="text-danger p-3">Error loading columns: ${error.message}</div>`;
            });
        }
        
        function displayAvailableColumns(dbResults) {
            """Display all available columns in draggable format"""
            const container = document.getElementById('availableColumnsContainer');
            let html = '';
            
            dbResults.forEach(({ db, tables }) => {
                if (tables.length > 0) {
                    html += `<div class="database-header">${db.name} (${db.type})</div>`;
                    
                    tables.forEach(table => {
                        table.columns.forEach(column => {
                            const columnId = `${db.path}|${table.name}|${column.name}`;
                            html += `<div class="column-item" 
                                        draggable="true" 
                                        ondragstart="dragStart(event)" 
                                        data-db-path="${db.path}"
                                        data-db-name="${db.name}"
                                        data-table="${table.name}"
                                        data-column="${column.name}"
                                        data-type="${column.type}"
                                        id="col_${btoa(columnId)}">
                                     <strong>${table.name}</strong>.${column.name} <small class="text-muted">(${column.type})</small>
                                 </div>`;
                        });
                    });
                }
            });
            
            if (html === '') {
                html = '<div class="text-muted p-3 text-center">No data sources found</div>';
            }
            
            container.innerHTML = html;
        }
        
        // Drag and Drop Functions
        function dragStart(event) {
            event.dataTransfer.setData('text/plain', event.target.id);
            event.target.classList.add('dragging');
        }
        
        function allowDrop(event) {
            event.preventDefault();
        }
        
        function dragEnter(event) {
            event.preventDefault();
            event.target.closest('.drag-drop-area').classList.add('drag-over');
        }
        
        function dragLeave(event) {
            if (!event.target.closest('.drag-drop-area').contains(event.relatedTarget)) {
                event.target.closest('.drag-drop-area').classList.remove('drag-over');
            }
        }
        
        function drop(event, axis) {
            event.preventDefault();
            const dropZone = event.target.closest('.drag-drop-area');
            dropZone.classList.remove('drag-over');
            
            const columnId = event.dataTransfer.getData('text/plain');
            const columnElement = document.getElementById(columnId);
            
            if (columnElement) {
                columnElement.classList.remove('dragging');
                addColumnToAxis(columnElement, axis);
            }
        }
        
        function addColumnToAxis(columnElement, axis) {
            """Add a column to X or Y axis"""
            const dbPath = columnElement.dataset.dbPath;
            const dbName = columnElement.dataset.dbName;
            const table = columnElement.dataset.table;
            const column = columnElement.dataset.column;
            const dataType = columnElement.dataset.type;
            
            // Check if column already selected for this axis
            const existingIndex = selectedColumns[axis].findIndex(
                item => item.dbPath === dbPath && item.table === table && item.column === column
            );
            
            if (existingIndex >= 0) {
                showMessage(`Column ${table}.${column} is already selected for ${axis.toUpperCase()}-axis`, 'error');
                return;
            }
            
            // Add to selected columns
            const columnData = {
                dbPath: dbPath,
                dbName: dbName,
                table: table,
                column: column,
                dataType: dataType,
                displayName: `${table}.${column}`,
                fullDisplayName: `${dbName} > ${table}.${column}`
            };
            
            selectedColumns[axis].push(columnData);
            
            // Update UI
            updateAxisDisplay(axis);
            columnElement.classList.add('in-use');
            
            // Load column statistics
            loadColumnStatistics(columnData, axis);
            
            updateGenerateCustomButton();
        }
        
        function updateAxisDisplay(axis) {
            """Update the display of selected columns for an axis"""
            const container = document.getElementById(`${axis}AxisColumns`);
            const columns = selectedColumns[axis];
            
            if (columns.length === 0) {
                container.innerHTML = `<span class="text-muted">Drop columns here for ${axis.toUpperCase()}-axis</span>`;
                return;
            }
            
            let html = '';
            columns.forEach((col, index) => {
                html += `<div class="column-item in-use" title="${col.fullDisplayName}">
                            ${col.displayName} <small class="text-muted">(${col.dataType})</small>
                            <button class="remove-column" onclick="removeColumnFromAxis('${axis}', ${index})" title="Remove">
                                √ó
                            </button>
                         </div>`;
            });
            
            container.innerHTML = html;
        }
        
        function removeColumnFromAxis(axis, index) {
            """Remove a column from axis selection"""
            const removedColumn = selectedColumns[axis][index];
            selectedColumns[axis].splice(index, 1);
            
            // Update UI
            updateAxisDisplay(axis);
            updateAxisStats(axis);
            
            // Remove 'in-use' class from source column
            const columnId = `col_${btoa(removedColumn.dbPath + '|' + removedColumn.table + '|' + removedColumn.column)}`;
            const sourceElement = document.getElementById(columnId);
            if (sourceElement) {
                sourceElement.classList.remove('in-use');
            }
            
            updateGenerateCustomButton();
        }
        
        function loadColumnStatistics(columnData, axis) {
            """Load and display statistics for a selected column"""
            // For now, show basic info - in a full implementation, you'd fetch actual column data
            const stats = {
                'Data Type': columnData.dataType,
                'Source': columnData.fullDisplayName,
                'Status': 'Ready for visualization'
            };
            
            updateAxisStats(axis);
        }
        
        function updateAxisStats(axis) {
            """Update statistics display for an axis"""
            const statsContainer = document.getElementById(`${axis}AxisStats`);
            const statsContent = document.getElementById(`${axis}AxisStatsContent`);
            const columns = selectedColumns[axis];
            
            if (columns.length === 0) {
                statsContainer.style.display = 'none';
                return;
            }
            
            let html = '<div class="row">';
            columns.forEach(col => {
                html += `<div class="col-md-6 mb-2">
                            <div class="card h-100">
                                <div class="card-body p-2">
                                    <h6 class="card-title text-truncate" title="${col.fullDisplayName}">${col.displayName}</h6>
                                    <p class="card-text small mb-1">Type: ${col.dataType}</p>
                                    <p class="card-text small mb-0 text-muted">Source: ${col.dbName}</p>
                                </div>
                            </div>
                         </div>`;
            });
            html += '</div>';
            
            statsContent.innerHTML = html;
            statsContainer.style.display = 'block';
        }
        
        function generateCustomVisualization() {
            """Generate visualization using selected columns"""
            if (selectedColumns.x.length === 0 && selectedColumns.y.length === 0) {
                showMessage('Please select at least one column for X or Y axis', 'error');
                return;
            }
            
            const welcomeMessage = document.getElementById('welcomeMessage');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const plotContainer = document.getElementById('plotContainer');
            const statsContainer = document.getElementById('statsContainer');
            const chartType = document.getElementById('chartTypeSelect').value;
            
            // Show loading state
            welcomeMessage.style.display = 'none';
            loadingSpinner.style.display = 'block';
            plotContainer.innerHTML = '';
            statsContainer.style.display = 'none';
            hideMessages();
            
            const requestData = {
                chart_type: chartType,
                x_columns: selectedColumns.x,
                y_columns: selectedColumns.y,
                visualization_name: 'Custom Multi-Column Chart'
            };
            
            fetch('/api/powerbuffet/run_custom_visualization', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                loadingSpinner.style.display = 'none';
                
                if (data.success) {
                    if (data.visualization.error) {
                        showMessage(`Visualization Error: ${data.visualization.error}`, 'error');
                    } else {
                        showMessage(`Custom ${chartType} visualization generated successfully!`, 'success');
                        
                        // Display the plot
                        if (data.visualization.plot_image) {
                            document.getElementById('plotContainer').innerHTML = 
                                `<img src="data:image/png;base64,${data.visualization.plot_image}" 
                                 class="img-fluid" alt="Custom Visualization" style="max-width: 100%; height: auto;">`;
                        }
                        
                        // Display summary statistics if available
                        if (data.visualization.summary_stats) {
                            displayStats(data.visualization.summary_stats);
                        }
                    }
                } else {
                    showMessage(`Error: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                loadingSpinner.style.display = 'none';
                showMessage(`Error generating custom visualization: ${error.message}`, 'error');
            });
        }
        
        function updateGenerateCustomButton() {
            """Enable/disable custom visualization button based on selections"""
            const button = document.getElementById('generateCustomBtn');
            const hasSelections = selectedColumns.x.length > 0 || selectedColumns.y.length > 0;
            button.disabled = !hasSelections;
        }
        
        function clearAllSelections() {
            """Clear all column selections"""
            selectedColumns.x = [];
            selectedColumns.y = [];
            
            updateAxisDisplay('x');
            updateAxisDisplay('y');
            updateAxisStats('x');
            updateAxisStats('y');
            
            // Remove in-use classes
            document.querySelectorAll('.column-item.in-use').forEach(el => {
                el.classList.remove('in-use');
            });
            
            updateGenerateCustomButton();
            showMessage('All selections cleared', 'success');
        }
        
        function loadSampleConfiguration() {
            """Load a sample configuration for demonstration"""
            clearAllSelections();
            
            // This would load a predefined configuration in a real implementation
            showMessage('Sample configuration loaded (feature coming soon)', 'info');
        }
        
        function saveConfiguration() {
            """Save current configuration"""
            if (selectedColumns.x.length === 0 && selectedColumns.y.length === 0) {
                showMessage('No configuration to save', 'error');
                return;
            }
            
            const config = {
                x_columns: selectedColumns.x,
                y_columns: selectedColumns.y,
                chart_type: document.getElementById('chartTypeSelect').value,
                timestamp: new Date().toISOString()
            };
            
            // In a real implementation, this would save to localStorage or server
            console.log('Configuration to save:', config);
            showMessage('Configuration saved to browser console', 'success');
        }
        
        // Initialize the enhanced interface
        document.addEventListener('DOMContentLoaded', function() {
            loadAllDatabasesAndColumns();
        });
        
        // Add event listeners
        document.getElementById('visualizationSelect').addEventListener('change', updateGenerateButton);
        document.getElementById('chartTypeSelect').addEventListener('change', updateGenerateCustomButton);
    </script>
</body>
</html>